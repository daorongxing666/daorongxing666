<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="这是我的个人博客，记录计算机学习之路！">
<meta property="og:type" content="website">
<meta property="og:title" content="阿荣的个人博客">
<meta property="og:url" content="https://www.arong.icu/index.html">
<meta property="og:site_name" content="阿荣的个人博客">
<meta property="og:description" content="这是我的个人博客，记录计算机学习之路！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Arong">
<meta name="twitter:card" content="summary"><title>阿荣的个人博客</title><link ref="canonical" href="https://www.arong.icu/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"恭喜您，复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fa fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fa fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fa fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fa fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fa fa-user"></i></span><span class="header-nav-menu-item__text">博主</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/read/"><span class="header-nav-menu-item__icon"><i class="fa fa-book"></i></span><span class="header-nav-menu-item__text">阅读</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">阿荣的个人博客</div><div class="header-banner-info__subtitle">一起学习学不完的计算机吧</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fa fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/49820/">线程安全问题</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-08-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">4.3k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">32分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h2 id="两个基本概念"   >
          <a href="#两个基本概念" class="heading-link"><i class="fas fa-link"></i></a>两个基本概念</h2>
      
        <h4 id="临界区"   >
          <a href="#临界区" class="heading-link"><i class="fas fa-link"></i></a>临界区</h4>
      <ul>
<li>多个线程读取共享资源的时候不会出现问题</li>
<li>但是多个线程对共享资源进行写操作的时候可能会出现指令的交错的问题</li>
<li>如果一段代码内存在对于共享资源的多线程读写操作，那么我们称这段代码为临界区</li>
</ul>

        <h4 id="竞态条件"   >
          <a href="#竞态条件" class="heading-link"><i class="fas fa-link"></i></a>竞态条件</h4>
      <p>多个线程在临界区内执行，由于代码的执行序列不同导致结果无法预测，称之为发生了竞态条件</p>

        <h2 id="synchronized"   >
          <a href="#synchronized" class="heading-link"><i class="fas fa-link"></i></a>synchronized</h2>
      <p>对象锁，他采用互斥的方式让同一时刻<strong>最多只有一个线程</strong>能够持有对象锁，其他线程想要读写临界区中的资源，就会进入阻塞状态，不用担心因为线程上下文切换而引发的指令交错问题。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(对象) &#123;</span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><img src="/source/images/1693913543945-670606e2-1e8b-4deb-8310-ea4467172140.png" alt="img"></p>
<p>原理：用 <strong>对象锁</strong> 确保了临界区内代码的原子性</p>
<p>也可以在方法上加上 synchronized</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">等价于</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"> <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line"> </span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>注意：</p>
<p>如果加的锁的对象是一致的话，才能够实现原子性，不同锁的对象相当于不加锁，例如：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(A.class) &#123;</span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span>(B.class) &#123;</span><br><span class="line">    <span class="comment">// 临界区</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>无法实现线程安全，因为他们对于锁的对象的限制是不同的。</p>
<p>同样的，对于 static 方法，也需要注意，因为他们如果加在方法上，说明他们锁的是类对象，而不是实例对象。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 临界区</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Number</span> <span class="variable">num1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(num1) &#123;</span><br><span class="line">                <span class="comment">// 临界区</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            Number.a();</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>这段代码也没有实现线程安全问题的解决，因为他们加锁的对象不是同一个，其中一个是实例对象类型，一个是 class 类型</p>

        <h2 id="变量的线程安全问题"   >
          <a href="#变量的线程安全问题" class="heading-link"><i class="fas fa-link"></i></a>变量的线程安全问题</h2>
      
        <h4 id="成员变量和局部变量是否线程安全"   >
          <a href="#成员变量和局部变量是否线程安全" class="heading-link"><i class="fas fa-link"></i></a>成员变量和局部变量是否线程安全</h4>
      <ul>
<li><p>如果他们没有共享，则他们是线程安全的。</p>
</li>
<li><p>如果他们被共享了：</p>
</li>
<li><ul>
<li>如果只有只读的操作，则他们线程安全</li>
<li>如果有读写操作，则这段代码是临界区，需要考虑线程安全问题。</li>
</ul>
</li>
</ul>

        <h4 id="局部变量是否线程安全"   >
          <a href="#局部变量是否线程安全" class="heading-link"><i class="fas fa-link"></i></a>局部变量是否线程安全</h4>
      <ul>
<li><p>局部变量是线程安全的</p>
</li>
<li><p>但局部变量引用的对象不一定</p>
</li>
<li><ul>
<li>如果该对象没有逃离方法的作用访问，那么他是线程安全的</li>
<li>如果该对象逃离方法的作用范围，那么需要考虑线程安全问题(可能同时被其他类引用)</li>
</ul>
</li>
</ul>

        <h2 id="常见线程安全类"   >
          <a href="#常见线程安全类" class="heading-link"><i class="fas fa-link"></i></a>常见线程安全类</h2>
      <ul>
<li>String</li>
<li>Integer</li>
<li>StringBuffer</li>
<li>Random</li>
<li>Vector</li>
<li>HashTable</li>
<li>java.util.concurrent 包下的类</li>
</ul>
<p>他们的方法都是原子的，因为涉及到操作系统底层的内容</p>

        <h2 id="Monitor"   >
          <a href="#Monitor" class="heading-link"><i class="fas fa-link"></i></a>Monitor</h2>
      <p>mark Word对象标记，存储对于该对象的加锁情况：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">|-------------------------------------------------------|--------------------|</span><br><span class="line">|             Mark <span class="title function_">Word</span> <span class="params">(<span class="number">32</span> bits)</span>                       |         State      |</span><br><span class="line">|-------------------------------------------------------|--------------------|</span><br><span class="line">|        hashcode:<span class="number">25</span> | age:<span class="number">4</span> | biased_lock:<span class="number">0</span>     | <span class="number">01</span>   |        Normal      |</span><br><span class="line">|-------------------------------------------------------|--------------------|</span><br><span class="line">| thread:<span class="number">23</span> | epoch:<span class="number">2</span> | age:<span class="number">4</span> | biased_lock:<span class="number">1</span>    | <span class="number">01</span>   |        Biased      |</span><br><span class="line">|-------------------------------------------------------|--------------------|</span><br><span class="line">|               ptr_to_lock_record:<span class="number">30</span>            | <span class="number">00</span>   | Lightweight Locked |</span><br><span class="line">|-------------------------------------------------------|--------------------|</span><br><span class="line">|         ptr_to_heavyweight_monitor:<span class="number">30</span>          | <span class="number">10</span>   | Heavyweight Locked |</span><br><span class="line">|-------------------------------------------------------|--------------------|</span><br><span class="line">|                                                | <span class="number">11</span>   |    Marked <span class="keyword">for</span> GC   |</span><br><span class="line">|-------------------------------------------------------|--------------------|</span><br></pre></td></tr></table></div></figure>




        <h4 id="Monitor-监视器模型"   >
          <a href="#Monitor-监视器模型" class="heading-link"><i class="fas fa-link"></i></a>Monitor 监视器模型</h4>
      <p><img src="/source/images/1693915171003-d8ab3fb8-b538-4e1c-81e9-016c879522b9.png" alt="img"></p>
<p>上图是Monitor监视器模型，他有<code>WaitSet</code>, <code>EntrySet</code>, <code>Owner</code>三个模型</p>
<p>当调用的临界区加上了 synchronized 对象锁后，就会触发属于该对象的监视器，注意，他和 synchronized 一样，每个对象的监视器是独有的。</p>
<ul>
<li>Thread1 调用了带有 synchronized 的临界区后，他会进入到 monitor 对象，检查其中的 Owner 是否有线程占用，没有的话则自己占用。</li>
<li>Thread2，3，4调用临界区后，发现 Owner 已经被 Thread1 占有了，那么他们会进入到 EntrySet 中进行等待，并且进入 Block 阻塞状态。</li>
<li>Thread0 因为某些原因在运用时候被打断了（比如被别的线程调用wait()指令），那么他就会进入到 WaitSet 区域等待唤醒，并且进入 Waiting 状态。</li>
</ul>

        <h2 id="Synchronized"   >
          <a href="#Synchronized" class="heading-link"><i class="fas fa-link"></i></a>Synchronized</h2>
      
        <h4 id="Synchronized-原理"   >
          <a href="#Synchronized-原理" class="heading-link"><i class="fas fa-link"></i></a>Synchronized 原理</h4>
      <p>字节码：</p>
<figure class="highlight ocaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: getstatic #<span class="number">2</span> // &lt;- lock引用 （synchronized开始）</span><br><span class="line"> <span class="number">3</span>: dup</span><br><span class="line"> <span class="number">4</span>: astore_1 // lock引用 -&gt; slot <span class="number">1</span></span><br><span class="line"> <span class="number">5</span>: monitorenter // 将 lock对象 <span class="type">MarkWord</span> 置为 <span class="type">Monitor</span> 指针</span><br><span class="line"> <span class="number">6</span>: getstatic #<span class="number">3</span> // &lt;- i</span><br><span class="line"> <span class="number">9</span>: iconst_1 // 准备常数 <span class="number">1</span></span><br><span class="line"> <span class="number">10</span>: iadd // +<span class="number">1</span></span><br><span class="line"> <span class="number">11</span>: putstatic #<span class="number">3</span> // -&gt; i</span><br><span class="line"> <span class="number">14</span>: aload_1 // &lt;- lock引用</span><br><span class="line"> <span class="number">15</span>: monitorexit // 将 lock对象 <span class="type">MarkWord</span> 重置, 唤醒 <span class="type">EntryList</span></span><br></pre></td></tr></table></div></figure>

<p>我们可以看到，他实质上是运用了<code>monitorenter</code>和<code>monitorexit</code>进行对象的监控，也就是说，Synchronized 是基于 Monitor 使用的。</p>

        <h4 id="轻量级锁"   >
          <a href="#轻量级锁" class="heading-link"><i class="fas fa-link"></i></a>轻量级锁</h4>
      <p>如果一个对象虽然有多线程要加锁，但加锁的时间是错开的（也就是没有竞争），那么可以使用轻量级锁来优化。</p>
<p>对于使用者，仍是调用<code>Synchronized</code>，但底层已经优化</p>

        <h4 id="Synchronized-加锁的过程"   >
          <a href="#Synchronized-加锁的过程" class="heading-link"><i class="fas fa-link"></i></a>Synchronized 加锁的过程</h4>
      <ul>
<li>创建锁记录（Lock Record）对象，每个线程都的栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的 Mark Word</li>
</ul>
<p><img src="/source/images/1693916026850-43da5061-dc78-4536-afac-64c41878d75a.png" alt="img"></p>
<ul>
<li>让锁记录中 Object reference 指向锁对象，并尝试用 cas 替换 Object 的 Mark Word，将 Mark Word 的值存入锁记录</li>
</ul>
<p><img src="/source/images/1693916049588-b7d95d2f-681d-4d02-af4b-b3be52287819.png" alt="img"></p>
<ul>
<li>如果 cas 替换成功，对象头中存储了 锁记录地址和状态 00 ，表示由该线程给对象加锁，这时图示如下</li>
</ul>
<p><img src="/source/images/1693916071476-d200ce33-50a0-44f4-b9af-9cb3f86d0b6e.png" alt="img"></p>
<ul>
<li><p>如果 cas 失败，有两种情况 </p>
</li>
<li><ul>
<li>如果是其它线程已经持有了该 Object 的轻量级锁，这时表明有竞争，进入锁膨胀过程 </li>
<li>如果是自己执行了 synchronized 锁重入，那么再添加一条 Lock Record 作为重入的计数</li>
</ul>
</li>
</ul>
<p><img src="/source/images/1693916102239-5717ab49-caba-49ec-a084-4ba3d1d1a977.png" alt="img"></p>
<ul>
<li>当退出 synchronized 代码块（解锁时）如果有取值为 null 的锁记录，表示有重入，这时重置锁记录，表示重入计数减一</li>
</ul>
<p><img src="/source/images/1693916126612-65fb28f2-3618-4acb-939d-cc100cc6a2f9.png" alt="img"></p>
<ul>
<li><p>当退出 synchronized 代码块（解锁时）锁记录的值不为 null，这时使用 cas 将 Mark Word 的值恢复给对象头 </p>
</li>
<li><ul>
<li>成功，则解锁成功 </li>
<li>失败，说明轻量级锁进行了锁膨胀或已经升级为重量级锁，进入重量级锁解锁流程</li>
</ul>
</li>
</ul>

        <h4 id="锁膨胀"   >
          <a href="#锁膨胀" class="heading-link"><i class="fas fa-link"></i></a>锁膨胀</h4>
      <p>开始我们检测到 synchronized 时候，加上的是轻量级锁，那么当我们要用 cas 操作加上轻量级锁的时候发现操作失败，说明有一种情况是已经有轻量级锁的存在了，那么这时候需要将锁升级为重量级锁。这个过程就叫做<strong>锁膨胀</strong></p>
<p><img src="/source/images/1693916798091-891a3843-6bf2-4527-ba2b-eb37a3e436cc.png" alt="img"></p>
<ul>
<li><p>这时 Thread-1 加轻量级锁失败，进入锁膨胀流程 </p>
</li>
<li><ul>
<li>即为 Object 对象申请 Monitor 锁，让 Object 指向重量级锁地址 </li>
<li>然后自己进入 Monitor 的 EntryList BLOCKED</li>
</ul>
</li>
</ul>
<p><img src="/source/images/1693916831099-155b5aab-2452-46ae-8a5e-34dec6bdcb0b.png" alt="img"></p>
<ul>
<li>当 Thread-0 退出同步块解锁时，使用 cas 将 Mark Word 的值恢复给对象头，失败。这时会进入重量级解锁流程，即按照 Monitor 地址找到 Monitor 对象，设置 Owner 为 null，唤醒 EntryList 中 BLOCKED 线程</li>
</ul>

        <h4 id="自旋优化"   >
          <a href="#自旋优化" class="heading-link"><i class="fas fa-link"></i></a>自旋优化</h4>
      <p>重量级锁竞争的时候，还可以使用自旋来进行优化，如果当前线程自旋成功（即这时候持锁线程已经退出了同步块，释放了锁），这时当前线程就可以避免阻塞。即多试几次。</p>
<p>在 Java 6 之后自旋锁是自适应的，比如对象刚刚的一次自旋操作成功过，那么认为这次自旋成功的可能性会高，就多自旋几次；反之，就少自旋甚至不自旋。</p>

        <h4 id="偏向锁"   >
          <a href="#偏向锁" class="heading-link"><i class="fas fa-link"></i></a>偏向锁</h4>
      <p>轻量级锁在没有竞争时（就自己这个线程），每次重入仍然需要执行 CAS 操作。</p>
<p>Java 6 中引入了偏向锁来做进一步优化：只有第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现这个线程 ID 是自己的就表示没有竞争，不用重新 CAS。以后只要不发生竞争，这个对象就归该线程所有 </p>
<p>开启偏向锁后，对象的 markword 值最后三位是 101</p>
<p>没有开启偏向锁，对象创建后 markword 的值为 001</p>

        <h4 id="撤销偏向锁"   >
          <a href="#撤销偏向锁" class="heading-link"><i class="fas fa-link"></i></a>撤销偏向锁</h4>
      <ul>
<li>调用对象 hashCode</li>
<li>其它线程使用对象</li>
<li>调用 wait&#x2F;notify</li>
</ul>

        <h4 id="批量重偏向"   >
          <a href="#批量重偏向" class="heading-link"><i class="fas fa-link"></i></a>批量重偏向</h4>
      <p>当撤销偏向锁阈值超过 20 次后，jvm 给这些对象加锁时重新偏向至加锁线程</p>

        <h4 id="批量撤销"   >
          <a href="#批量撤销" class="heading-link"><i class="fas fa-link"></i></a>批量撤销</h4>
      <p>当撤销偏向锁阈值超过 40 次后，整个类的所有对象都会变为不可偏向的，新建的对象也是不可偏向的</p>

        <h4 id="锁消除"   >
          <a href="#锁消除" class="heading-link"><i class="fas fa-link"></i></a>锁消除</h4>
      <p>当只有一个临界区加上锁，且只有一个线程执行，那么系统会自动运用锁消除技术。减轻系统负担。</p>

        <h2 id="wait-notify-notifyAll"   >
          <a href="#wait-notify-notifyAll" class="heading-link"><i class="fas fa-link"></i></a>wait notify notifyAll</h2>
      
        <h4 id="sleep-和-wait-的区别"   >
          <a href="#sleep-和-wait-的区别" class="heading-link"><i class="fas fa-link"></i></a>sleep() 和 wait() 的区别</h4>
      <ol>
<li>sleep() 是 Thread 类的方法，wait() 是 object 类的方法</li>
<li>wait() 一定要在 synchronized 代码块中使用，而 sleep() 不一定</li>
<li>sleep() 不会释放对象锁，wait() 会释放对象锁</li>
<li>它们的状态都是 TIMED_WAITING</li>
</ol>
<p>notify 随机唤醒线程，并不固定，可以采用 notifyAll 进行全部唤醒</p>

        <h2 id="同步设计模式——保护式暂停"   >
          <a href="#同步设计模式——保护式暂停" class="heading-link"><i class="fas fa-link"></i></a>同步设计模式——保护式暂停</h2>
      
        <h3 id="guardObject"   >
          <a href="#guardObject" class="heading-link"><i class="fas fa-link"></i></a>guardObject</h3>
      <p>两个线程同时监听着一个中间件，生产者将产品置为成员变量，消费者监听到成员变量里的值不为null，才取出产品。</p>
<p><img src="/source/images/1693997334508-36faae9e-6ae0-45db-b75f-9f65dc2c9323.png" alt="img"></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.GuardedSuspension&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuardedSuspension</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GuardObject</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardObject</span>();</span><br><span class="line">        <span class="comment">// 线程1 等待 线程2 传递的资源</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始等待获取结果&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> go.get();</span><br><span class="line">            log.debug(<span class="string">&quot;获取到了结果: &#123;&#125;&quot;</span>, o);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                go.complete(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GuardObject</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 结果储存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">            <span class="comment">// 没有值的情况下，一直等待</span></span><br><span class="line">            <span class="keyword">while</span>(response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;获取到结果：&#123;&#125;&quot;</span>, response);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="带超时版"   >
          <a href="#带超时版" class="heading-link"><i class="fas fa-link"></i></a>带超时版</h3>
      <p>这个的设计主要就是 <code>join()</code>方法的设计，其主要运用了当前时间和运行时间的比较，再将他们进行对比。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.GuardedSuspensionPassedTime&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuardedSuspensionPassedTime</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">GuardObjectPassedTime</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardObjectPassedTime</span>();</span><br><span class="line">        <span class="comment">// 线程1 等待 线程2 传递的资源</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;开始等待获取结果&quot;</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> go.get(<span class="number">3000L</span>);</span><br><span class="line">            log.debug(<span class="string">&quot;获取到了结果: &#123;&#125;&quot;</span>, o);</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                go.complete(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;获取结果成功&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.GuardObjectPassedTime&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GuardObjectPassedTime</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 结果储存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> millis)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">current</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">passed</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">            <span class="comment">// 没有值的情况下，一直等待</span></span><br><span class="line">            <span class="keyword">while</span>(response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(passed &gt;= millis) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait(millis - passed);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 已经等待的时间</span></span><br><span class="line">                passed = System.currentTimeMillis() - current;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="面向对象demo"   >
          <a href="#面向对象demo" class="heading-link"><i class="fas fa-link"></i></a>面向对象demo</h3>
      <p>主要运用了一个 <code>Futures</code>中间件，将对象们封装了起来</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.GuardedSuspensionMutiple&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuardedSuspensionMutiple</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">People</span>().start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">for</span>(Integer id : Futures.getKeySet()) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Postman</span>(id, <span class="string">&quot;message&quot;</span> + id).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.People&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;开始等待收信&quot;</span>);</span><br><span class="line">        <span class="type">GuardMutipleObject</span> <span class="variable">guardMutipleObject</span> <span class="operator">=</span> Futures.createGuardMutipleObject();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> guardMutipleObject.get();</span><br><span class="line">        log.debug(<span class="string">&quot;收到信了: id: &#123;&#125; response: &#123;&#125;&quot;</span>,guardMutipleObject.getId(), o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.Postman&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Postman</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer postmanId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Postman</span><span class="params">(Integer postmanId, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.postmanId = postmanId;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getPostmanId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> postmanId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardMutipleObject</span> <span class="variable">guardMutipleObject</span> <span class="operator">=</span> Futures.getGuardMutipleObject(postmanId);</span><br><span class="line">        log.debug(<span class="string">&quot;送信 id:&#123;&#125;, 内容:&#123;&#125;&quot;</span>, postmanId, message);</span><br><span class="line">        guardMutipleObject.complete(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Futures</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, GuardMutipleObject&gt; guardMutipleObjectMap = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Integer</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Integer <span class="title function_">generateId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取任务并且移除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardMutipleObject <span class="title function_">getGuardMutipleObject</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> guardMutipleObjectMap.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardMutipleObject <span class="title function_">createGuardMutipleObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardMutipleObject</span> <span class="variable">guardMutipleObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardMutipleObject</span>(generateId());</span><br><span class="line">        guardMutipleObjectMap.put(guardMutipleObject.getId(), guardMutipleObject);</span><br><span class="line">        <span class="keyword">return</span> guardMutipleObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取任务编号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Integer&gt; <span class="title function_">getKeySet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> guardMutipleObjectMap.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GuardMutipleObject</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GuardMutipleObject</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 结果储存</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(lock) &#123;</span><br><span class="line">            <span class="comment">// 没有值的情况下，一直等待</span></span><br><span class="line">            <span class="keyword">while</span>(response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;获取到结果：&#123;&#125;&quot;</span>, response);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h2 id="异步设计模式——消费者和生产者"   >
          <a href="#异步设计模式——消费者和生产者" class="heading-link"><i class="fas fa-link"></i></a>异步设计模式——消费者和生产者</h2>
      <p>类比消息队列，但是消息队列中是进程之间的关系，而这里是线程之间的关系</p>
<p><img src="/source/images/1693997637001-ed8d54c5-a686-4048-aa99-a477626660c8.png" alt="img"></p>
<p>这里主要相比较于前面的同步，无需再做到对象的一一对应，生产者仅负责产生结果数据，不关心数据该如何处理，而消费者专心处理结果数据。且他是有容量限制的，满时不会再加入数据，空时不会再消耗数据</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.arong.JUC.async;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Deque;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MessageQueue</span> <span class="variable">mq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">StandardMessage</span> <span class="variable">message</span> <span class="operator">=</span> mq.take();</span><br><span class="line">                <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> message.getMessage();</span><br><span class="line">                log.debug(<span class="string">&quot;take message(&#123;&#125;): [&#123;&#125;] lines&quot;</span>, message.getId(), response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;消费者&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="type">StandardMessage</span> <span class="variable">standardMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardMessage</span>(i, <span class="string">&quot;往消息队列发送了消息：&quot;</span> + i);</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt; &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;发送消息： &#123;&#125;&quot;</span>, standardMessage);</span><br><span class="line">                mq.put(standardMessage);</span><br><span class="line">            &#125;,<span class="string">&quot;生产者&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.MessageQueue&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageQueue</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer Capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储信息的队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;StandardMessage&gt; list  = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    MessageQueue(Integer capacity) &#123;</span><br><span class="line">        <span class="built_in">this</span>.Capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(StandardMessage sm)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="comment">// 队列满了的时候</span></span><br><span class="line">            <span class="keyword">while</span>(list.size() == Capacity) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;队列已满&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            list.addFirst(sm);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> StandardMessage <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">while</span>(list.isEmpty()) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;队列已空&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">StandardMessage</span> <span class="variable">standardMessage</span> <span class="operator">=</span> list.removeLast();</span><br><span class="line">            list.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> standardMessage;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StandardMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;StandardMessage&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, message=&#x27;&quot;</span> + message + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StandardMessage</span><span class="params">(Integer id, String message)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h2 id="Park-amp-UnPark"   >
          <a href="#Park-amp-UnPark" class="heading-link"><i class="fas fa-link"></i></a>Park &amp; UnPark</h2>
      <p>与 Object 的 wait &amp; notify 相比 ：</p>
<ul>
<li>wait，notify 和 notifyAll 必须配合 Object Monitor 一起使用，而 park，unpark 不必 </li>
<li>park &amp; unpark 是以线程为单位来【阻塞】和【唤醒】线程，而 notify 只能随机唤醒一个等待线程，notifyAll是唤醒所有等待线程，就不那么【精确】 </li>
<li>park &amp; unpark 可以先 unpark，而 wait &amp; notify 不能先 notify</li>
</ul>

        <h2 id="线程状态"   >
          <a href="#线程状态" class="heading-link"><i class="fas fa-link"></i></a>线程状态</h2>
      <p>假设有线程 Thread t </p>

        <h4 id="情况-1-NEW-–-gt-RUNNABLE"   >
          <a href="#情况-1-NEW-–-gt-RUNNABLE" class="heading-link"><i class="fas fa-link"></i></a>情况 1 NEW –&gt; RUNNABLE</h4>
      <ul>
<li>当调用 <code>t.start()</code> 方法时，由 <code>NEW --&gt; RUNNABLE</code></li>
</ul>

        <h4 id="情况-2-RUNNABLE-lt-–-gt-WAITING"   >
          <a href="#情况-2-RUNNABLE-lt-–-gt-WAITING" class="heading-link"><i class="fas fa-link"></i></a>情况 2 RUNNABLE &lt;–&gt; WAITING</h4>
      <p><strong>t 线程</strong>用 <code>synchronized(obj)</code> 获取了对象锁后 </p>
<ul>
<li><p>调用 <code>obj.wait()</code> 方法时，<strong>t 线程</strong>从 <code>RUNNABLE --&gt; WAITING</code> </p>
</li>
<li><p>调用 <code>obj.notify()</code> ， <code>obj.notifyAll()</code> ， <code>t.interrupt()</code> 时 </p>
</li>
<li><ul>
<li>竞争锁成功，<strong>t 线程</strong>从<code>WAITING --&gt; RUNNABLE</code></li>
<li>竞争锁失败，<strong>t 线程</strong>从<code>WAITING --&gt; BLOCKED</code></li>
</ul>
</li>
</ul>

        <h4 id="情况-3-RUNNABLE-lt-–-gt-WAITING"   >
          <a href="#情况-3-RUNNABLE-lt-–-gt-WAITING" class="heading-link"><i class="fas fa-link"></i></a>情况 3 RUNNABLE &lt;–&gt; WAITING</h4>
      <ul>
<li><strong>当前线程</strong>调用 t.join() 方法时，<strong>当前线程</strong>从 <code>RUNNABLE --&gt; WAITING</code></li>
</ul>
<p>注意是<strong>当前线程</strong>在<strong>t 线程对象</strong>的监视器上等待 </p>
<ul>
<li><strong>t 线程</strong>运行结束，或调用了<strong>当前线程</strong>的 interrupt() 时，<strong>当前线程</strong>从<code>WAITING --&gt; RUNNABLE</code></li>
</ul>

        <h4 id="情况-4-RUNNABLE-lt-–-gt-WAITING"   >
          <a href="#情况-4-RUNNABLE-lt-–-gt-WAITING" class="heading-link"><i class="fas fa-link"></i></a>情况 4 RUNNABLE &lt;–&gt; WAITING</h4>
      <ul>
<li>当前线程调用 LockSupport.park() 方法会让当前线程从 <code>RUNNABLE --&gt; WAITING</code> </li>
<li>调用 LockSupport.unpark(目标线程) 或调用了线程 的 interrupt() ，会让目标线程从 <code>WAITING --&gt; RUNNABLE</code></li>
</ul>

        <h4 id="情况-5-RUNNABLE-lt-–-gt-TIMED-WAITING"   >
          <a href="#情况-5-RUNNABLE-lt-–-gt-TIMED-WAITING" class="heading-link"><i class="fas fa-link"></i></a>情况 5 RUNNABLE &lt;–&gt; TIMED_WAITING</h4>
      <ul>
<li><p>调用 obj.wait(long n) 方法时，<strong>t 线程</strong>从 <code>RUNNABLE --&gt; TIMED_WAITING</code> </p>
</li>
<li><p><strong>t 线程</strong>等待时间超过了 n 毫秒，或调用 obj.notify() ， obj.notifyAll() ， t.interrupt() 时 </p>
</li>
<li><ul>
<li>竞争锁成功，<strong>t 线程</strong>从 <code>TIMED_WAITING --&gt; RUNNABLE</code> </li>
<li>竞争锁失败，<strong>t 线程</strong>从 <code>TIMED_WAITING --&gt; BLOCKED</code></li>
</ul>
</li>
</ul>

        <h4 id="情况-6-RUNNABLE-lt-–-gt-TIMED-WAITING"   >
          <a href="#情况-6-RUNNABLE-lt-–-gt-TIMED-WAITING" class="heading-link"><i class="fas fa-link"></i></a>情况 6 RUNNABLE &lt;–&gt; TIMED_WAITING</h4>
      <ul>
<li><strong>当前线程</strong>调用 t.join(long n) 方法时，<strong>当前线程</strong>从 <code>RUNNABLE --&gt; TIMED_WAITING</code></li>
</ul>
<p>注意是<strong>当前线程</strong>在<strong>t 线程对象</strong>的监视器上等待 </p>
<ul>
<li><strong>当前线程</strong>等待时间超过了 n 毫秒，或<strong>t 线程</strong>运行结束，或调用了<strong>当前线程</strong>的 interrupt() 时，<strong>当前线程</strong>从 <code>TIMED_WAITING --&gt; RUNNABLE</code></li>
</ul>

        <h4 id="情况-7-RUNNABLE-lt-–-gt-TIMED-WAITING"   >
          <a href="#情况-7-RUNNABLE-lt-–-gt-TIMED-WAITING" class="heading-link"><i class="fas fa-link"></i></a>情况 7 RUNNABLE &lt;–&gt; TIMED_WAITING</h4>
      <ul>
<li>当前线程调用 Thread.sleep(long n) ，当前线程从 <code>RUNNABLE --&gt; TIMED_WAITING</code> </li>
<li><strong>当前线程</strong>等待时间超过了 n 毫秒，<strong>当前线程</strong>从<code>TIMED_WAITING --&gt; RUNNABLE</code></li>
</ul>

        <h4 id="情况-8-RUNNABLE-lt-–-gt-TIMED-WAITING"   >
          <a href="#情况-8-RUNNABLE-lt-–-gt-TIMED-WAITING" class="heading-link"><i class="fas fa-link"></i></a>情况 8 RUNNABLE &lt;–&gt; TIMED_WAITING</h4>
      <ul>
<li>当前线程调用 LockSupport.parkNanos(long nanos) 或 LockSupport.parkUntil(long millis) 时，<strong>当前线程</strong>从 <code>RUNNABLE --&gt; TIMED_WAITING</code></li>
<li>调用 LockSupport.unpark(目标线程) 或调用了线程 的 interrupt() ，或是等待超时，会让目标线程从<code>TIMED_WAITING--&gt; RUNNABLE</code></li>
</ul>

        <h4 id="情况-9-RUNNABLE-lt-–-gt-BLOCKED"   >
          <a href="#情况-9-RUNNABLE-lt-–-gt-BLOCKED" class="heading-link"><i class="fas fa-link"></i></a>情况 9 RUNNABLE &lt;–&gt; BLOCKED</h4>
      <ul>
<li><strong>t线程</strong>用synchronized(obj) 获取了对象锁时如果竞争失败，从<code>RUNNABLE --&gt; BLOCKED</code> </li>
<li>持 obj 锁线程的同步代码块执行完毕，会唤醒该对象上所有 <code>BLOCKED</code> 的线程重新竞争，如果其中 <strong>t 线程</strong>竞争成功，从 <code>BLOCKED --&gt; RUNNABLE</code> ，其它失败的线程仍然<code>BLOCKED</code></li>
</ul>

        <h4 id="情况-10-RUNNABLE-lt-–-gt-TERMINATED"   >
          <a href="#情况-10-RUNNABLE-lt-–-gt-TERMINATED" class="heading-link"><i class="fas fa-link"></i></a>情况 10 RUNNABLE &lt;–&gt; TERMINATED</h4>
      <ul>
<li>当前线程所有代码运行完毕，进入 <code>TERMINATED</code></li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/35861/">java线程</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-14</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-08</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.2k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">7分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="创建和运行线程"   >
          <a href="#创建和运行线程" class="heading-link"><i class="fas fa-link"></i></a>创建和运行线程</h1>
      
        <h2 id="直接使用-Thread-创建线程"   >
          <a href="#直接使用-Thread-创建线程" class="heading-link"><i class="fas fa-link"></i></a>直接使用 Thread 创建线程</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新建线程对象 参数为线程名称</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;t1&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 要执行的任务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 启动线程</span></span><br><span class="line">t1.start();</span><br></pre></td></tr></table></div></figure>




        <h2 id="使用-Runnable-配合-Thread"   >
          <a href="#使用-Runnable-配合-Thread" class="heading-link"><i class="fas fa-link"></i></a>使用 Runnable 配合 Thread</h2>
      <blockquote>
<p>runnable 代表了可运行的任务，将线程和任务进行分离</p>
</blockquote>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 要执行的任务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 创建线程对象</span></span><br><span class="line"><span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnbale, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line"><span class="comment">// 启动线程</span></span><br><span class="line">t2.start();</span><br></pre></td></tr></table></div></figure>




        <h2 id="FutureTask-配合-Thread"   >
          <a href="#FutureTask-配合-Thread" class="heading-link"><i class="fas fa-link"></i></a>FutureTask 配合 Thread</h2>
      <blockquote>
<p> FutureTask 也是表示了任务，他和 runnable 的区别在于他有返回值，而 Runnable 没有返回值。</p>
</blockquote>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 创建任务对象 泛型表示返回的对象</span></span><br><span class="line"> <span class="comment">// lambda表达式将函数作为参数进行传递</span></span><br><span class="line"> FutureTask&lt;Integer&gt; task3 = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(() -&gt; &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(task3, <span class="string">&quot;t3&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取返回结果</span></span><br><span class="line"><span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> task3.get();</span><br></pre></td></tr></table></div></figure>


        <h2 id="多个线程同时运行"   >
          <a href="#多个线程同时运行" class="heading-link"><i class="fas fa-link"></i></a>多个线程同时运行</h2>
      <ul>
<li>交替运行</li>
<li>先后顺序不由我们控制，而由底层的操作系统进行控制</li>
</ul>

        <h2 id="查看进程线程的方法"   >
          <a href="#查看进程线程的方法" class="heading-link"><i class="fas fa-link"></i></a>查看进程线程的方法</h2>
      
        <h3 id="windows"   >
          <a href="#windows" class="heading-link"><i class="fas fa-link"></i></a>windows</h3>
      <p><code>taskList</code>  查看进程<br><code>taskkill</code> 杀死进程</p>

        <h3 id="linux"   >
          <a href="#linux" class="heading-link"><i class="fas fa-link"></i></a>linux</h3>
      <p><code>ps -fe</code> 查看所有进程<br><code>ps -fT -p &lt;PID&gt;</code> 查看某个进程（PID）的所有线程<br><code>kill</code> 杀死进程</p>

        <h3 id="java"   >
          <a href="#java" class="heading-link"><i class="fas fa-link"></i></a>java</h3>
      <p><code>jps</code> 查看所有的 java 进程<br><code>jstack &lt;PID&gt;</code>  查看某个 Java 进程的所有线程状态<br><code>jconsole</code> 查看运行状态（图形界面）</p>

        <h2 id="线程运行的原理"   >
          <a href="#线程运行的原理" class="heading-link"><i class="fas fa-link"></i></a>线程运行的原理</h2>
      
        <h3 id="栈与栈帧"   >
          <a href="#栈与栈帧" class="heading-link"><i class="fas fa-link"></i></a>栈与栈帧</h3>
      <ul>
<li><p>每个线程启动之后，虚拟机会为其分配一块栈内存。</p>
</li>
<li><p>每个栈由多个栈帧（Frame） 组成，对应着每次方法调用时候所占用的内存</p>
</li>
<li><p>每个线程只能有一个活动栈帧，对应着当前正在执行的方法</p>
</li>
</ul>

        <h3 id="线程的上下文切换"   >
          <a href="#线程的上下文切换" class="heading-link"><i class="fas fa-link"></i></a>线程的上下文切换</h3>
      <p>上下文切换，即 CPU 分配的时间片由一个线程转为另一个线程，也即切换线程<br>导致上下文切换可能的原因：</p>
<ul>
<li>线程的 CPU 时间片用完</li>
<li>垃圾回收</li>
<li>有更高级的线程需要运行</li>
<li>线程自己调用了 sleep，yield，wait，join，park，synchronized，lock 等方法<br>  当上下文切换执行后，需要由操作系统保存当前线程的状态，并恢复另一个线程的状态。java 中通常通过程序计数器来实现，上下文切换的频繁发生会影响性能。</li>
</ul>

        <h2 id="线程的常见方法"   >
          <a href="#线程的常见方法" class="heading-link"><i class="fas fa-link"></i></a>线程的常见方法</h2>
      
        <h3 id="run-和-Start"   >
          <a href="#run-和-Start" class="heading-link"><i class="fas fa-link"></i></a>run() 和 Start()</h3>
      <ul>
<li>run() 方法是线程中一个重写执行逻辑的方法，如果在主程序单独的调用线程的run方法，只是实现了其中的逻辑，而没有启动线程。</li>
<li>start() 启动了新的线程，在新的线程中执行 run() 方法等方法。</li>
</ul>

        <h3 id="sleep-和-yield"   >
          <a href="#sleep-和-yield" class="heading-link"><i class="fas fa-link"></i></a>sleep() 和 yield()</h3>
      <ul>
<li>sleep()<br>  ○ 调用他会让线程从 Running 进入到 Timed Waiting 状态（阻塞）<br>  ○ 可以使用 interrupt 打断正在睡眠的线程，此时会抛出 InterruptedException错误。</li>
<li>yield()<br>  ○ 调用他会让线程从 Running 进入到 Runnable 状态<br>  ○ 具体执行逻辑取决于任务调度器</li>
</ul>

        <h3 id="join"   >
          <a href="#join" class="heading-link"><i class="fas fa-link"></i></a>join()</h3>
      <p>  等待 join() 的调用者的任务执行完成之后，在进行下一步的操作。可以理解成局部线程的同步。其中参数可以添加时间，取到线程执行任务时间和参数传递的时间的最小值作为最多等待的时间。</p>

        <h3 id="interrupt"   >
          <a href="#interrupt" class="heading-link"><i class="fas fa-link"></i></a>interrupt</h3>
      <p>打断 sleep， wait， join 的线程，并抛出InterruptedException异常，如果是 sleep 状态的线程被打断，会清空打断状态，即t.isInterrupted() &#x3D; false<br>如果是打断正常运行的线程，那么t.isInterrupted() &#x3D; true</p>

        <h2 id="主线程与守护线程"   >
          <a href="#主线程与守护线程" class="heading-link"><i class="fas fa-link"></i></a>主线程与守护线程</h2>
      <p>只要非守护线程运行结束了，那么即使守护线程的代码没有执行完成，也会强制结束。<br>设置守护线程：t1.setDaemon(true);</p>

        <h2 id="线程的状态"   >
          <a href="#线程的状态" class="heading-link"><i class="fas fa-link"></i></a>线程的状态</h2>
      
        <h3 id="五种状态（从操作系统层面来讲）"   >
          <a href="#五种状态（从操作系统层面来讲）" class="heading-link"><i class="fas fa-link"></i></a>五种状态（从操作系统层面来讲）</h3>
      <ul>
<li>[初始状态]，刚 new 出来的对象，仅仅是对象层面，还没有和线程相关联。</li>
<li>[可运行状态]，指该线程已经被创建，可以被 CPU 调度运行。</li>
<li>[运行状态]，获取了CPU时间片的运行中的状态，当 CPU 时间片用完时，会从运行状态转换为可运行状态，导致线程的上下文切换。</li>
<li>[阻塞状态]，线程进行上下文切换到其他的状态，只要一直不被唤醒，调度器就一直不会考虑调度他们。</li>
<li>[终止状态]，表示线程已经执行完毕，生命周期已经结束，不会再转变为其他的状态。</li>
</ul>

        <h3 id="六种状态（从-JAVA-API-的层面描述）"   >
          <a href="#六种状态（从-JAVA-API-的层面描述）" class="heading-link"><i class="fas fa-link"></i></a>六种状态（从 JAVA API 的层面描述）</h3>
      <ul>
<li>new， 如同操作系统中的初始状态，指线程刚刚被创建</li>
<li>runnable， 包括了操作系统中的可运行状态，运行状态和阻塞状态</li>
<li>blocked，加锁导致的阻塞</li>
<li>waiting，调用 wait()方法之后的阻塞</li>
<li>timed_waiting， 调用 wait()方法之后的阻塞，但是有时限</li>
<li>terminated，终止状态。</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/52642/">线程与进程</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-07-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">481</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">2分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="1-进程与线程"   >
          <a href="#1-进程与线程" class="heading-link"><i class="fas fa-link"></i></a>1. 进程与线程</h1>
      
        <h2 id="进程与线程"   >
          <a href="#进程与线程" class="heading-link"><i class="fas fa-link"></i></a>进程与线程</h2>
      <ul>
<li>进程：可被视为程序的一个实例，可以视为由指令和数据组成。进程就是用来加载指令，管理内存，管理io的。</li>
<li>线程：一个进程之内可以有多个线程同时运行，线程可以视为是进程的一个子集。可被视为一个个指令流，将指令流中的一条条指令依次顺序执行。<ul>
<li>线程为最小调度单位，进程为资源分配的最小单位</li>
<li>进程拥有共享的资源，如内存空间可以使内部的线程实现共享。</li>
</ul>
</li>
</ul>

        <h2 id="并行和并发"   >
          <a href="#并行和并发" class="heading-link"><i class="fas fa-link"></i></a>并行和并发</h2>
      <ul>
<li>并发是同一时间应对多件事情的能力</li>
<li>并行是同一时间动手做多件事情的能力</li>
</ul>

        <h2 id="同步和异步"   >
          <a href="#同步和异步" class="heading-link"><i class="fas fa-link"></i></a>同步和异步</h2>
      <ul>
<li>同步指的是需要等待结果返回才能继续运行</li>
<li>异步是指无需等待结果返回，仍然能够运行</li>
</ul>
<ol>
<li><p>单核 cpu 下，多线程不能实际提高程序运行效率，只是为了能够在不同的任务之间切换，不同线程轮流使用 cpu ，不至于一个线程总占用 cpu，别的线程没法干活 </p>
</li>
<li><p>多核 cpu 可以并行跑多个线程，但能否提高程序运行效率还是要分情况的 有些任务，经过精心设计，将任务拆分，并行执行，当然可以提高程序的运行效率。但不是所有计算任务都能拆分，也不是所有任务都需要拆分，任务的目的如果不同，谈拆分和效率没有意义 </p>
</li>
<li><p>IO 操作不占用 cpu，只是我们一般拷贝文件使用的是【阻塞 IO】，这时相当于线程虽然不用 cpu，但需要一直等待 IO 结束，没能充分利用线程。所以才有后面的【非阻塞 IO】和【异步 IO】优化</p>
</li>
</ol>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/7738/">观察者模式</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">473</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">3分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="1-定义"   >
          <a href="#1-定义" class="heading-link"><i class="fas fa-link"></i></a>1.定义</h1>
      <p>观察者模式定义了一种一堆多的依赖关系，当一个对象的状态发生改变时，所有依赖于它对象都会得到通知。观察者模式也被成为发布-订阅模式。实现了解耦，在需要新增一个观察者的时候只需要new一个出来，然后注册到主题对象就可以了，在观察者不需要观察该主题对象，只需要在主题对象的观察者列表中去除该观察者对象即可。</p>

        <h1 id="2-结构图"   >
          <a href="#2-结构图" class="heading-link"><i class="fas fa-link"></i></a>2.结构图</h1>
      <p><img src="/source/images/1684047286505-98076c31-46e4-4ebe-b0ec-7080c0d6d71f.png" alt="img"></p>
<ul>
<li><code>Subject</code>: 被观察者的对象抽象类。其中包含了观察者的集合，添加和删除观察者的方法。还有通知观察者观察对象已改变的方法</li>
<li><code>Observer</code>：抽象观察者类。只有一个响应接口，响应接口中定义了被观察者。响应接口除了需要做出需要做的事情之外，还需要将自己注册到被观察者中去。</li>
</ul>

        <h1 id="3-实例"   >
          <a href="#3-实例" class="heading-link"><i class="fas fa-link"></i></a>3.实例</h1>
      
        <h3 id="被观察者的对象抽象类"   >
          <a href="#被观察者的对象抽象类" class="heading-link"><i class="fas fa-link"></i></a>被观察者的对象抽象类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 被观察的对象父类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义一个集合存储被观察者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Observer&gt; observerList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加监听者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addObserver</span><span class="params">(Observer observer)</span> &#123;</span><br><span class="line">        observerList.add(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除监听者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> observer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteObserver</span><span class="params">(Observer observer)</span> &#123;</span><br><span class="line">        observerList.remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 做出什么事情后，监听者会有所反应</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">signature</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">report</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(Observer observer : observerList) &#123;</span><br><span class="line">            observer.response(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="观察者抽象类"   >
          <a href="#观察者抽象类" class="heading-link"><i class="fas fa-link"></i></a>观察者抽象类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="comment">// 监听者的反应</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">response</span><span class="params">(Subject subject)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="具体被观察者类"   >
          <a href="#具体被观察者类" class="heading-link"><i class="fas fa-link"></i></a>具体被观察者类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">signature</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我要吃饭呜呜呜&quot;</span>);</span><br><span class="line">        report();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>




        <h3 id="具体观察者类"   >
          <a href="#具体观察者类" class="heading-link"><i class="fas fa-link"></i></a>具体观察者类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> <span class="keyword">implements</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">response</span><span class="params">(Subject subject)</span> &#123;</span><br><span class="line">        subject.addObserver(<span class="built_in">this</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;老师说：好好学习，以后每顿都能吃上两个肉&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/58639/">策略模式</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-13</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">362</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">2分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="1-定义"   >
          <a href="#1-定义" class="heading-link"><i class="fas fa-link"></i></a>1.定义</h1>
      <p>其用意是针对一组算法，将每一个算法封装到具有共同接口的独立的类中，从而使得它们可以相互替换。策略模式使得算法可以在不影响到客户端的情况下发生变化。<br>其主要目的是通过定义相似的算法，替换if else 语句写法，并且可以随时相互替换。</p>

        <h1 id="2-结构图"   >
          <a href="#2-结构图" class="heading-link"><i class="fas fa-link"></i></a>2.结构图</h1>
      <p><img src="/source/images/1684052516266-83d31e2f-2ecc-4a43-9f45-1fbdc92a7517.png" alt="img"></p>
<ul>
<li>环境角色(Context)：持有一个策略类的引用，提供给客户端使用。</li>
<li>抽象策略角色(Strategy)：这是一个抽象角色，通常由一个接口或抽象类实现。此角色给出所有的具体策略类所需的接口。</li>
<li>具体策略角色(ConcreteStrategy)：包装了相关的算法或行为。</li>
</ul>

        <h1 id="3-实例"   >
          <a href="#3-实例" class="heading-link"><i class="fas fa-link"></i></a>3.实例</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StrategyUseService</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;UpgradeWay, Upgrade&gt; upgradeMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">deResolve</span><span class="params">(UpgradeWay upgradeWay, Long experience)</span> &#123;</span><br><span class="line">        upgradeWay = Optional.ofNullable(upgradeWay).orElse(UpgradeWay.SLEEP);</span><br><span class="line">        <span class="type">Upgrade</span> <span class="variable">upgrade</span> <span class="operator">=</span> upgradeMap.get(upgradeWay);</span><br><span class="line">        <span class="keyword">if</span>(upgrade == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> upgrade.resolve(experience);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// spring初始化初始化时候即初始化各种策略</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        Map&lt;String, Upgrade&gt; beansOfType = applicationContext.getBeansOfType(Upgrade.class);</span><br><span class="line">        beansOfType.values().forEach(strategyService  -&gt; upgradeMap.put(strategyService.gainUpgradeWay(), strategyService));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Upgrade</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取策略类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 策略类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UpgradeWay <span class="title function_">gainUpgradeWay</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具体实现逻辑</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> experience 原有经验值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Long <span class="title function_">resolve</span><span class="params">(Long experience)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>



<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SleepUpgrade</span> <span class="keyword">implements</span> <span class="title class_">Upgrade</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UpgradeWay <span class="title function_">gainUpgradeWay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UpgradeWay.SLEEP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">resolve</span><span class="params">(Long experience)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.gainUpgradeWay().getValue() + experience;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/10970/">内存</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-12</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.4k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">7分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="缓存池的作用"   >
          <a href="#缓存池的作用" class="heading-link"><i class="fas fa-link"></i></a>缓存池的作用</h1>
      <p>缓存池主要是为了加快数据的查询效率。如果每个查询语句都到磁盘中的数据库进行查询的话，那么进行io执行效率不高。所以在内存中开辟了一块空间，用来存储高频的查询语句，目的是为了提高查询效率。</p>
<ul>
<li>当执行一条查询语句时，执行器会先到缓存池中寻找，如果命中，就直接返回。如果未命中，就到磁盘里读取数据，在将这条数据加入到缓存池中。</li>
<li>当执行一条更新语句时，会先进行查询定位要原始语句，流程同上，更新完会同时更新缓存池中的数据，同时将缓存池中的数据标记为脏页。等到合适的时候将内存刷盘，更新到磁盘中。</li>
</ul>

        <h1 id="缓存池的容量"   >
          <a href="#缓存池的容量" class="heading-link"><i class="fas fa-link"></i></a>缓存池的容量</h1>
      <p>Buffer Pool 是在 MySQL 启动的时候，向操作系统申请的一片连续的内存空间，默认配置下 Buffer Pool 只有 <code>128MB</code> 。</p>
<p>可以通过调整 <code>innodb_buffer_pool_size</code> 参数来设置 Buffer Pool 的大小，一般建议设置成可用物理内存的 <code>60%~80%</code>。</p>

        <h1 id="缓存池的存储结构"   >
          <a href="#缓存池的存储结构" class="heading-link"><i class="fas fa-link"></i></a>缓存池的存储结构</h1>
      <p>在Inno db中，数据的存储以页为单位。一个页中有保存了多条数据。根据缓存一致性原理，查询的时候会将其附近的语句一起加载。那么在缓存池中，也会同样以页为单位进行存储，一个页的大小默认为<code>16kb</code>。每个页中的结构有数据页，索引页，插入缓存页，undo log页，自适应哈希索引页，锁信息页。为了能够更好的管理页，每个页开头都有一个控制块进行管理，控制块中的信息包括缓存页的表空间、页号、缓存页地址、链表节点等。</p>

        <h1 id="缓存池的功能"   >
          <a href="#缓存池的功能" class="heading-link"><i class="fas fa-link"></i></a>缓存池的功能</h1>
      
        <h2 id="管理空闲页"   >
          <a href="#管理空闲页" class="heading-link"><i class="fas fa-link"></i></a>管理空闲页</h2>
      <p><img src="/source/images/1686539614795-25436072-b95c-4ca7-a736-1341f420b054.png" alt="img"></p>
<p>采用链表结构，将控制块作为链表节点。通过设置一个free链表来快速定位到空闲页的位置。减少了查询的数据量。</p>

        <h2 id="管理脏页"   >
          <a href="#管理脏页" class="heading-link"><i class="fas fa-link"></i></a>管理脏页</h2>
      <p><img src="/source/images/1686539696705-baa031ff-6e1c-4a03-ac8c-e12af23e756f.png" alt="img"></p>
<p>基本上相当于空闲页的结构。</p>

        <h2 id="提高缓存命中率"   >
          <a href="#提高缓存命中率" class="heading-link"><i class="fas fa-link"></i></a>提高缓存命中率</h2>
      
        <h3 id="原始LRU结构"   >
          <a href="#原始LRU结构" class="heading-link"><i class="fas fa-link"></i></a>原始LRU结构</h3>
      <p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://leetcode.cn/problems/lru-cache/" >LRU数据结构</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>LRU主要是为了提高数据读取效率而设计的。他的主要功能是最近访问的信息会出现在链表的头部，所以他被叫做：last receive user（最近使用）</p>
<p>最朴素的LRU结构的特点就是，</p>
<ul>
<li>查询数据的时候，如果数据在LRU链表中，就将其提前到链表的头部。</li>
<li>如果数据不在链表中，就在内存中将数据插入LRU链表的头部，同时将LRU的最后一个元素退出队列。</li>
</ul>
<p>但是这种结构很少被使用，因为他会导致一些问题：</p>
<ul>
<li>预读失效</li>
<li>缓存池污染</li>
</ul>

        <h3 id="解决预读失效"   >
          <a href="#解决预读失效" class="heading-link"><i class="fas fa-link"></i></a>解决预读失效</h3>
      <p>预读指的是因为内存的空间局部性原理，当查询到一个数据的时候也会将其临近内存地址的数据一起添加。为了减少磁盘io。针对于程序的空间局部性原理，是大部分情况下成立的，但是在一部分情况下预读的页完全没有被访问到。但是他会存储在链表头部，挤占后面链表的空间。大大降低了缓存的命中率。</p>
<p>解决预读失效的方法是将其划分为新生代和老年代，预读的页加入old区域的头部，等到真正读取到的时候，才进入young区域的头部。这样既兼顾了缓存一致性的原理，有防止因为预读失效而让热点数据过期的风险。等到新数据插入的时候，优先淘汰old区域的节点。young区域的最后一个节点进入old区域。</p>

        <h3 id="解决缓存池污染"   >
          <a href="#解决缓存池污染" class="heading-link"><i class="fas fa-link"></i></a>解决缓存池污染</h3>
      <p>当一条sql语句查询出大量数据的时候，他们可能只被查询了一次，但是却一起被加载到缓存区中。把原有的高频缓存数据挤占出去。</p>
<p>mysql在进入到 young 区域条件增加了一个停留在 old 区域的时间判断。</p>
<p>具体是这样做的，在对某个处在 old 区域的缓存页进行第一次访问时，就在它对应的控制块中记录下来这个访问时间：</p>
<ul>
<li>如果后续的访问时间与第一次访问的时间在某个时间间隔内，那么该缓存页就不会被从 old 区域移动到 young 区域的头部；</li>
<li>如果后续的访问时间与第一次访问的时间不在某个时间间隔内，那么该缓存页移动到 young 区域的头部；</li>
</ul>
<p>这个间隔时间是由 innodb_old_blocks_time 控制的，默认是 1000 ms。</p>
<p>也就说，只有同时满足「被访问」与「在 old 区域停留时间超过 1 秒」两个条件，才会被插入到 young 区域头部，这样就解决了 Buffer Pool 污染的问题 。</p>

        <h2 id="脏页刷入磁盘的时机"   >
          <a href="#脏页刷入磁盘的时机" class="heading-link"><i class="fas fa-link"></i></a>脏页刷入磁盘的时机</h2>
      <p>下面几种情况会触发脏页的刷新：</p>
<ul>
<li>当 redo log 日志满了的情况下，会主动触发脏页刷新到磁盘；</li>
<li>Buffer Pool 空间不足时，需要将一部分数据页淘汰掉，如果淘汰的是脏页，需要先将脏页同步到磁盘；</li>
<li>MySQL 认为空闲时，后台线程会定期将适量的脏页刷入到磁盘；</li>
<li>MySQL 正常关闭之前，会把所有的脏页刷入到磁盘；</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/32353/">日志</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-11</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">2.9k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">16分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="undo-log"   >
          <a href="#undo-log" class="heading-link"><i class="fas fa-link"></i></a>undo log</h1>
      
        <h2 id="undo-log的作用"   >
          <a href="#undo-log的作用" class="heading-link"><i class="fas fa-link"></i></a>undo log的作用</h2>
      <p><img src="/source/images/1686403146475-2f741c8f-70bf-4370-b050-dabfa1bf7063.png" alt="img"></p>
<ul>
<li><p>实现事务的回滚，保证事务的原子性</p>
</li>
<li><ul>
<li>其主要实现就是将当前数据库操作取反，写入undo log中，比如新增一条语句，就记录其主键，回滚时删除；删除语句则将对应数据存入日志中；修改则存入原语句。</li>
</ul>
</li>
</ul>
<p>很多人疑问 undo log 是如何刷盘（持久化到磁盘）的？</p>
<p>undo log 和数据页的刷盘策略是一样的，都需要通过 redo log 保证持久化。</p>
<p>buffer pool 中有 undo 页，对 undo 页的修改也都会记录到 redo log。redo log 会每秒刷盘，提交事务时也会刷盘，数据页和 undo 页都是靠这个机制保证持久化的。</p>
<ul>
<li><p>通过与Read View的配合实现MVCC多版本并发控制。一次事务操作产生的undo log中有<code>trx_id</code> 和<code>roll_pointer</code>两个参数。<code>trx_id</code>指的是事务的id，<code>roll_pointer</code>指的是一个指针，用来将事务联系起来。主要用来记录<strong>事务产生的先后顺序</strong>。这样结合read view可以实现可重复读和和一定程度上预防幻读。</p>
</li>
<li><ul>
<li>undo log 为每条记录保存多份历史数据，MySQL 在执行快照读（普通 select 语句）的时候，会根据事务的 Read View 里的信息，顺着 undo log 的版本链找到满足其可见性的记录。</li>
</ul>
</li>
</ul>
<p><img src="/source/images/1686403178895-140051c5-9ab5-4ecc-9907-b5fc3a33dc51.png" alt="img"></p>

        <h2 id="Buffer-pool缓存池的作用"   >
          <a href="#Buffer-pool缓存池的作用" class="heading-link"><i class="fas fa-link"></i></a>Buffer pool缓存池的作用</h2>
      <p>其作用和内存的作用大差不差：</p>
<ul>
<li>当读取数据的时候，执行器会先有限在缓存池中找是否存在数据，如果命中缓存，则直接返回；如果没有命中，再到磁盘中进行寻找。</li>
<li>当修改数据的时候，会先在缓存池中寻找要修改的数据是否存在，如果存在的话，会先修改缓存中的数据，同时将其标记为脏页。由参数指定将脏页由缓存更新到磁盘的时间。</li>
</ul>
<p>在mysql启动的时候，Inno DB会在缓存池中建立一个一个的页，每页的大小为<code>16kb</code>，开始的时候页是空的，会随着一条条查询操作而填充页。</p>
<p><img src="/source/images/1686402938998-9bfb712c-18df-4dab-aa2f-f93834288ff7.png" alt="img"></p>
<p>我们的undo log就记录在这当中的undo页中。</p>
<p>读取数据的时候，是一页一页的缓存，需要满足数据一致性原则。</p>

        <h1 id="redo-log"   >
          <a href="#redo-log" class="heading-link"><i class="fas fa-link"></i></a>redo log</h1>
      
        <h2 id="redo-log的作用"   >
          <a href="#redo-log的作用" class="heading-link"><i class="fas fa-link"></i></a>redo log的作用</h2>
      <p>redo log是用于记录数据库事务的每一条修改，删除，新增操作。目的是为了防止数据库因为外部原因崩溃宕机而导致的数据丢失。redo log记录了一次事务完成后的数据状态，记录的是数据更新之后的值。</p>
<p>因为redo log是对于<code>buffer pool</code>中进行标记脏页（修改）的操作进行记录，所以undo log也会被记录到redo log中进行持久化。</p>
<p>在sql执行中redo log的功能：</p>
<p><img src="/source/images/1686404019090-66759e64-894f-4fde-9a66-ef7afbdb2f18.png" alt="img"></p>
<p>undo log 和redo log在一个事务中的作用：</p>
<p><img src="/source/images/1686403982838-d58027bf-961b-4574-b9f6-15f15897ac85.png" alt="img"></p>
<ul>
<li>有了 redo log，再通过 WAL 技术，InnoDB 就可以保证即使数据库发生异常重启，之前已提交的记录都不会丢失，这个能力称为<code>crash-safe</code>（崩溃恢复）。可以看出来， redo log 保证了事务四大特性中的持久性。</li>
<li>将写入磁盘的方式由随机写改为顺序写，提高了io效率。</li>
</ul>
<p>WAL技术：MySQL 的写操作并不是立刻写到磁盘上，而是先写日志，然后在合适的时间再写到磁盘上。采用了追加操作进行写入，所以WAL写入数据的方式是顺序写。</p>

        <h2 id="redo-log刷盘时机分析"   >
          <a href="#redo-log刷盘时机分析" class="heading-link"><i class="fas fa-link"></i></a>redo log刷盘时机分析</h2>
      <ul>
<li><p>MySQL 正常关闭时；</p>
</li>
<li><p>当 redo log buffer 中记录的写入量大于 redo log buffer 内存空间的一半时，会触发落盘；</p>
</li>
<li><p>InnoDB 的后台线程每隔 1 秒，将 redo log buffer 持久化到磁盘。</p>
</li>
<li><p>每次事务提交时都将缓存在 redo log buffer 里的 redo log 直接持久化到磁盘（这个策略可由 <code>innodb_flush_log_at_trx_commit</code> 参数控制，下面会说）。</p>
</li>
<li><ul>
<li>当设置该参数为 0 时，表示每次事务提交时 ，还是将 redo log 留在 redo log buffer 中 ，该模式下在事务提交时不会主动触发写入磁盘的操作。</li>
<li>当设置该参数为 1 时，表示每次事务提交时，都将缓存在 redo log buffer 里的 redo log 直接持久化到磁盘，这样可以保证 MySQL 异常重启之后数据不会丢失。</li>
<li>当设置该参数为 2 时，表示每次事务提交时，都只是缓存在 redo log buffer 里的 redo log 写到 redo log 文件，注意写入到「 redo log 文件」并不意味着写入到了磁盘，因为操作系统的文件系统中有个 Page Cache专门用来缓存文件数据的，所以写入「 redo log文件」意味着写入到了操作系统的文件缓存。</li>
</ul>
</li>
</ul>
<p>InnoDB 的后台线程每隔 1 秒：</p>
<ul>
<li>针对参数 0 ：会把缓存在 redo log buffer 中的 redo log ，通过调用 write() 写到操作系统的 Page Cache，然后调用 fsync() 持久化到磁盘。所以参数为 0 的策略，MySQL 进程的崩溃会导致上一秒钟所有事务数据的丢失;</li>
<li>针对参数 2 ：调用 fsync，将缓存在操作系统中 Page Cache 里的 redo log 持久化到磁盘。所以参数为 2 的策略，较取值为 0 情况下更安全，因为 MySQL 进程的崩溃并不会丢失数据，只有在操作系统崩溃或者系统断电的情况下，上一秒钟所有事务数据才可能丢失。</li>
<li>数据安全性：参数 1 &gt; 参数 2 &gt; 参数 0</li>
<li>写入性能：参数 0 &gt; 参数 2&gt; 参数 1</li>
</ul>

        <h1 id="binlog"   >
          <a href="#binlog" class="heading-link"><i class="fas fa-link"></i></a>binlog</h1>
      
        <h2 id="redo-log和binlog有什么区别"   >
          <a href="#redo-log和binlog有什么区别" class="heading-link"><i class="fas fa-link"></i></a>redo log和binlog有什么区别</h2>
      <ul>
<li><p>适用对象的不同</p>
</li>
<li><ul>
<li>redo log是inno db独有的日志格式</li>
<li>binlog是所有存储引擎都适用的，他服务于service层</li>
</ul>
</li>
<li><p>写入的方式不同</p>
</li>
<li><ul>
<li>redo log采用的是循环写，会对前面的内容产生覆盖</li>
<li>binlog采用的是追加写，写满一个文件，会创建一个新的文件继续写，不会覆盖前面的内容</li>
</ul>
</li>
<li><p>作用不同</p>
</li>
<li><ul>
<li>redo log主要为了防止突发的系统宕机导致数据不同步的问题</li>
<li>binlog主要是为了实现备份的恢复以及主从复制</li>
</ul>
</li>
</ul>

        <h2 id="如何实现主从复制"   >
          <a href="#如何实现主从复制" class="heading-link"><i class="fas fa-link"></i></a>如何实现主从复制</h2>
      <ul>
<li>MySQL 主库在收到客户端提交事务的请求之后，会先写入 binlog，再提交事务，更新存储引擎中的数据，事务提交完成后，返回给客户端“操作成功”的响应。</li>
<li>从库会创建一个专门的 I&#x2F;O 线程，连接主库的 log dump 线程，来接收主库的 binlog 日志，再把 binlog 信息写入 relay log 的中继日志里，再返回给主库“复制成功”的响应。</li>
<li>从库会创建一个用于回放 binlog 的线程，去读 relay log 中继日志，然后回放 binlog 更新存储引擎中的数据，最终实现主从的数据一致性。</li>
</ul>
<p>关键点：写数据从主库操作，读数据从从库操作。异步执行，读写分离。但缺点是可能会信息无法立刻同步导致读取的字段是旧数据。</p>

        <h2 id="binlog的刷盘的时机"   >
          <a href="#binlog的刷盘的时机" class="heading-link"><i class="fas fa-link"></i></a>binlog的刷盘的时机</h2>
      <p>MySQL提供一个 sync_binlog 参数来控制数据库的 binlog 刷到磁盘上的频率：</p>
<ul>
<li>sync_binlog &#x3D; 0 的时候，表示每次提交事务都只 write，不 fsync，后续交由操作系统决定何时将数据持久化到磁盘；</li>
<li>sync_binlog &#x3D; 1 的时候，表示每次提交事务都会 write，然后马上执行 fsync；</li>
<li>sync_binlog &#x3D;N(N&gt;1) 的时候，表示每次提交事务都 write，但累积 N 个事务后才 fsync。</li>
</ul>
<p>sql语句更新的执行流程：</p>
<ol>
<li>执行器负责具体执行，会调用存储引擎的接口，通过主键索引树搜索获取 id &#x3D; 1 这一行记录：</li>
</ol>
<ul>
<li><ul>
<li>如果 id&#x3D;1 这一行所在的数据页本来就在 buffer pool 中，就直接返回给执行器更新；</li>
<li>如果记录不在 buffer pool，将数据页从磁盘读入到 buffer pool，返回记录给执行器。</li>
</ul>
</li>
</ul>
<ol>
<li>执行器得到聚簇索引记录后，会看一下更新前的记录和更新后的记录是否一样：</li>
</ol>
<ul>
<li><ul>
<li>如果一样的话就不进行后续更新流程；</li>
<li>如果不一样的话就把更新前的记录和更新后的记录都当作参数传给 InnoDB 层，让 InnoDB 真正的执行更新记录的操作；</li>
</ul>
</li>
</ul>
<ol>
<li>开启事务， InnoDB 层更新记录前，首先要记录相应的 undo log，因为这是更新操作，需要把被更新的列的旧值记下来，也就是要生成一条 undo log，undo log 会写入 Buffer Pool 中的 Undo 页面，不过在内存修改该 Undo 页面后，需要记录对应的 redo log。</li>
<li>InnoDB 层开始更新记录，会先更新内存（同时标记为脏页），然后将记录写到 redo log 里面，这个时候更新就算完成了。为了减少磁盘I&#x2F;O，不会立即将脏页写入磁盘，后续由后台线程选择一个合适的时机将脏页写入到磁盘。这就是 WAL 技术，MySQL 的写操作并不是立刻写到磁盘上，而是先写 redo 日志，然后在合适的时间再将修改的行数据写到磁盘上。</li>
<li>至此，一条记录更新完了。</li>
<li>在一条更新语句执行完成后，然后开始记录该语句对应的 binlog，此时记录的 binlog 会被保存到 binlog cache，并没有刷新到硬盘上的 binlog 文件，在事务提交时才会统一将该事务运行过程中的所有 binlog 刷新到硬盘。</li>
</ol>

        <h1 id="两阶段提交"   >
          <a href="#两阶段提交" class="heading-link"><i class="fas fa-link"></i></a>两阶段提交</h1>
      <ul>
<li>如果在将 redo log 刷入到磁盘之后， MySQL 突然宕机了，而 binlog 还没有来得及写入。MySQL 重启后，通过 redo log 能将 Buffer Pool 中 id &#x3D; 1 这行数据的 name 字段恢复到新值 xiaolin，但是 binlog 里面没有记录这条更新语句，在主从架构中，binlog 会被复制到从库，由于 binlog 丢失了这条更新语句，从库的这一行 name 字段是旧值 jay，与主库的值不一致性；</li>
<li>如果在将 binlog 刷入到磁盘之后， MySQL 突然宕机了，而 redo log 还没有来得及写入。由于 redo log 还没写，崩溃恢复以后这个事务无效，所以 id &#x3D; 1 这行数据的 name 字段还是旧值 jay，而 binlog 里面记录了这条更新语句，在主从架构中，binlog 会被复制到从库，从库执行了这条更新语句，那么这一行 name 字段是新值 xiaolin，与主库的值不一致性；</li>
</ul>
<p>事务的提交过程有两个阶段，就是将 redo log 的写入拆成了两个步骤：prepare 和 commit，中间再穿插写入binlog，具体如下：</p>
<ul>
<li>prepare 阶段：将 XID（内部 XA 事务的 ID） 写入到 redo log，同时将 redo log 对应的事务状态设置为 prepare，然后将 redo log 持久化到磁盘（innodb_flush_log_at_trx_commit &#x3D; 1 的作用）；</li>
<li>commit 阶段：把 XID 写入到 binlog，然后将 binlog 持久化到磁盘（sync_binlog &#x3D; 1 的作用），接着调用引擎的提交事务接口，将 redo log 状态设置为 commit，此时该状态并不需要持久化到磁盘，只需要 write 到文件系统的 page cache 中就够了，因为只要 binlog 写磁盘成功，就算 redo log 的状态还是 prepare 也没有关系，一样会被认为事务已经执行成功；</li>
</ul>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/24714/">类结构和类加载</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">1.7k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">9分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="1-类文件结构"   >
          <a href="#1-类文件结构" class="heading-link"><i class="fas fa-link"></i></a>1. 类文件结构</h1>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line">    u4             magic; <span class="comment">//Class 文件的标志</span></span><br><span class="line">    u2             minor_version;<span class="comment">//Class 的小版本号</span></span><br><span class="line">    u2             major_version;<span class="comment">//Class 的大版本号</span></span><br><span class="line">    u2             constant_pool_count;<span class="comment">//常量池的数量</span></span><br><span class="line">    cp_info        constant_pool[constant_pool_count-<span class="number">1</span>];<span class="comment">//常量池</span></span><br><span class="line">    u2             access_flags;<span class="comment">//Class 的访问标记</span></span><br><span class="line">    u2             this_class;<span class="comment">//当前类</span></span><br><span class="line">    u2             super_class;<span class="comment">//父类</span></span><br><span class="line">    u2             interfaces_count;<span class="comment">//接口</span></span><br><span class="line">    u2             interfaces[interfaces_count];<span class="comment">//一个类可以实现多个接口</span></span><br><span class="line">    u2             fields_count;<span class="comment">//Class 文件的字段属性</span></span><br><span class="line">    field_info     fields[fields_count];<span class="comment">//一个类会可以有多个字段</span></span><br><span class="line">    u2             methods_count;<span class="comment">//Class 文件的方法数量</span></span><br><span class="line">    method_info    methods[methods_count];<span class="comment">//一个类可以有个多个方法</span></span><br><span class="line">    u2             attributes_count;<span class="comment">//此类的属性表中的属性数</span></span><br><span class="line">    attribute_info attributes[attributes_count];<span class="comment">//属性表集合</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="1-1-魔数-amgic"   >
          <a href="#1-1-魔数-amgic" class="heading-link"><i class="fas fa-link"></i></a>1.1 魔数(amgic)</h2>
      <p>唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件。即进行<strong>类型识别</strong>。使用魔数而不使用文件拓展名是为了安全考虑。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u4             magic; <span class="comment">//Class 文件的标志</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="1-2-版本号-minor-version-amp-major-version"   >
          <a href="#1-2-版本号-minor-version-amp-major-version" class="heading-link"><i class="fas fa-link"></i></a>1.2 版本号(minor_version &amp; major_version)</h2>
      <p>高版本的JDK能向下兼容以前版本的Class文件，但不能运行以后版本的Class文件。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u2             minor_version;<span class="comment">//Class 的小版本号</span></span><br><span class="line">u2             major_version;<span class="comment">//Class 的大版本号</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="1-3-常量池"   >
          <a href="#1-3-常量池" class="heading-link"><i class="fas fa-link"></i></a>1.3 常量池</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u2             constant_pool_count;<span class="comment">//常量池的数量</span></span><br><span class="line">cp_info        constant_pool[constant_pool_count-<span class="number">1</span>];<span class="comment">//常量池</span></span><br></pre></td></tr></table></div></figure>
<p><code>constant_pool_count</code>表示常量池的容量，索引从1开始，到他的数量-1.第0项常量表示不引用任何常量，默认为空。</p>
<blockquote>
<p>0x0016：表示为十进制是22，表示有21个常量，索引从1-21<br>主要存放两类常量：字面量和符号引用<br>每一项常量都是一个表，表开始是u1类型的标志位。<br><img src="/source/images/1bcc0033df92b50d7db8ef484f54e88.png"></p>
</blockquote>

        <h2 id="1-4-访问标志"   >
          <a href="#1-4-访问标志" class="heading-link"><i class="fas fa-link"></i></a>1.4 访问标志</h2>
      <p>识别类或接口层次的访问消息。<br><img src="/source/images/ca3c4e7fd521b481e238d400f9a4757.png"></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u2             access_flags;<span class="comment">//Class 的访问标记</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="1-5-类索引，父类索引和接口索引集合"   >
          <a href="#1-5-类索引，父类索引和接口索引集合" class="heading-link"><i class="fas fa-link"></i></a>1.5 类索引，父类索引和接口索引集合</h2>
      <p>当前类要设置全限名，所有的都有父类，除了java.lang.Object，接口可以多实现。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">u2             this_class;<span class="comment">//当前类</span></span><br><span class="line">u2             super_class;<span class="comment">//父类</span></span><br><span class="line">u2             interfaces_count;<span class="comment">//接口</span></span><br><span class="line">u2             interfaces[interfaces_count];<span class="comment">//一个类可以实现多个接口</span></span><br></pre></td></tr></table></div></figure>

        <h2 id="1-6-字段表集合"   >
          <a href="#1-6-字段表集合" class="heading-link"><i class="fas fa-link"></i></a>1.6 字段表集合</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u2             fields_count;<span class="comment">//Class 文件的字段属性</span></span><br><span class="line">field_info     fields[fields_count];<span class="comment">//一个类会可以有多个字段</span></span><br></pre></td></tr></table></div></figure>
<p>字段表格式：</p>
<ul>
<li><code>access_flags</code>: 字段的作用域（public ,private,protected修饰符），是实例变量还是类变量（static修饰符）,可否被序列化（transient 修饰符）,可变性（final）,可见性（volatile 修饰符，是否强制从主内存读写）。</li>
<li><code>name_index</code>: 对常量池的引用，表示的字段的名称；</li>
<li><code>descriptor_index</code>: 对常量池的引用，表示字段和方法的描述符；</li>
<li><code>attributes_count</code>: 一个字段还会拥有一些额外的属性，attributes_count 存放属性的个数；</li>
<li><code>attributes[attributes_count]</code>: 存放具体属性具体内容。<br>字段表标志位：<br><img src="/source/images/ba74348c5a074791abadabda1534dbf3.png"></li>
</ul>

        <h2 id="1-7-方法表集合"   >
          <a href="#1-7-方法表集合" class="heading-link"><i class="fas fa-link"></i></a>1.7 方法表集合</h2>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">u2             methods_count;<span class="comment">//Class 文件的方法数量</span></span><br><span class="line">method_info    methods[methods_count];<span class="comment">//一个类可以有个多个方法</span></span><br></pre></td></tr></table></div></figure>
<p>方法表结构：<br><img src="/source/images/4efb6101e08445499f2faf59f34963f4.png"><br>方法表标志位：<br><img src="/source/images/d8137412775c419b948902e79dee14da.png"></p>

        <h1 id="2-类加载机制"   >
          <a href="#2-类加载机制" class="heading-link"><i class="fas fa-link"></i></a>2. 类加载机制</h1>
      <p>类的生命周期：<br><img src="/source/images/b724a4d759f8f67fbdac422a0eac658.png"><br>类加载的时机：</p>
<ul>
<li>创建类的实例，也就是<code>new</code>一个对象。</li>
<li>访问类的静态方法或者静态变量（包含静态变量赋值）。</li>
<li>使用<code>Class.forName()</code>反射类。</li>
<li>子类初始化的时候。</li>
<li>JVM启动时标明的启动类。</li>
</ul>

        <h2 id="2-1-加载"   >
          <a href="#2-1-加载" class="heading-link"><i class="fas fa-link"></i></a>2.1 加载</h2>
      <ol>
<li>通过一个类的全限定名来获取定义此类的二进制字节流。</li>
<li>将这个流的静态存储结构转换为方法区运行时数据结构。</li>
<li>生成一个Class对象<br>jvm是<strong>懒加载</strong>，所以只有使用到类时才会加载，例如调用类的main()方法，new对象等等 ，主类在运行过程中如果使用到其它类，会逐步加载这些类。</li>
</ol>

        <h2 id="2-2-验证"   >
          <a href="#2-2-验证" class="heading-link"><i class="fas fa-link"></i></a>2.2 验证</h2>
      <ul>
<li>文件格式验证</li>
<li>元数据验证</li>
<li>字节码验证</li>
<li>符号引用验证</li>
</ul>

        <h2 id="2-3-准备"   >
          <a href="#2-3-准备" class="heading-link"><i class="fas fa-link"></i></a>2.3 准备</h2>
      <p>为类中定义的变量(被<code>static</code>修饰过的变量)分配内存并设置类变量初始值。此阶段不包含实例变量的赋值。</p>

        <h2 id="2-4-解析"   >
          <a href="#2-4-解析" class="heading-link"><i class="fas fa-link"></i></a>2.4 解析</h2>
      <p>将符号引用转换为直接引用。</p>
<ul>
<li>符号引用： 描述对象，包括如下三种：<br>类和接口的全限定名<br>字段的名称和描述符<br>方法的名称和描述符</li>
<li>直接引用：<br>变量有一个内存地址来标识，如果我们用一个指针指向这个内存地址，这个指针就是直接引用。<br>等我们需要用到这个变量的时候，就可以直接通过指针指向的地址找到。<br>而我们在加载类的时候，解析代码并指向内存某个地址，然后将符号引用 obj和这个内存地址进行映射的过程，就是解析这个步骤要做的事，也叫做符号引用转换为直接引用。</li>
</ul>

        <h2 id="2-5-初始化"   >
          <a href="#2-5-初始化" class="heading-link"><i class="fas fa-link"></i></a>2.5 初始化</h2>
      <p>（1）对类的静态变量初始化为指定的值<br><code>int initData = 666</code><br>（2）执行静态代码块<br><code>&lt;clinit&gt;()</code></p>

        <h1 id="3-类加载器"   >
          <a href="#3-类加载器" class="heading-link"><i class="fas fa-link"></i></a>3. 类加载器</h1>
      
        <h2 id="3-1-类加载器的种类"   >
          <a href="#3-1-类加载器的种类" class="heading-link"><i class="fas fa-link"></i></a>3.1 类加载器的种类</h2>
      <p><img src="/source/images/47266cb826c74981b21ded13641ed666.png"></p>
<ul>
<li>启动类加载器（Bootstrap ClassLoader）：负责加载Java类的核心类(<code>&lt;JAVA_HOME&gt;\lib</code>目录下，能被<code>-Xbootclasspath</code>参数所指定路径存放的)，是用C++代码实现的，无法被java代码直接引用。</li>
<li>扩展类加载器（Extensions ClassLoader）：负责加载JRE的扩展目录lib&#x2F;ext或者由java.ext.dirs系统属性指定的目录中的JAR包的类。由Java语言实现，父类加载器为Null。</li>
<li>应用程序类加载器（Application ClassLoader）： 负责加载用户类路径 classpath 上所有的 jar 包和 .class 文件。</li>
</ul>

        <h2 id="3-2-双亲委派模型"   >
          <a href="#3-2-双亲委派模型" class="heading-link"><i class="fas fa-link"></i></a>3.2 双亲委派模型</h2>
      <p>工作过程：<br>如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的类加载器都是如此，因此所有的夹杂请求最终都应该传送到顶层的启动类加载器中，只有父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。<br>简而言之：<font color=red>自下而上请求，自上而下加载</font><br>优势：<br>父类加载器成功加载则返回，子类加载器不会再加载，防止了重复加载。<br>防止核心API库被随意篡改。比如有一个要加载java.lang.Integer类的请求，通过双亲委派进制加载传递到启动类加载器，在在核心Java API发现这个名字的类，发现该类已被加载，并不会重新加载传递的过来的java.lang.Integer，而直接返回已加载过的Integer.class，可以防止核心API被随意篡改。</p>
<p><a href="/source/images.classAll.png"></a></p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/60015/">责任链模式</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">639</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">4分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="1-基本概念"   >
          <a href="#1-基本概念" class="heading-link"><i class="fas fa-link"></i></a>1.基本概念</h1>
      <p>这是一个可以说是过关斩将的设计模式，责任链就像是一道道关卡，你只有闯过了上一关，才能到达下一关继续闯荡。在责任链模式里，很多对象由<strong>每一个对象对其下家的引用</strong>而连接起来形成一条链。请求在这个链上传递，<strong>直到链上的某一个对象决定处理此请求</strong>。发出这个请求的客户端并不知道链上的哪一个对象最终处理这个请求，这使得系统可以在不影响客户端的情况下动态地重新组织和分配责任。</p>

        <h1 id="2-责任链模式的使用场景"   >
          <a href="#2-责任链模式的使用场景" class="heading-link"><i class="fas fa-link"></i></a>2.责任链模式的使用场景</h1>
      <ul>
<li>多条件流程判断：权限控制（此处指的是嵌套的循环判断）</li>
<li>ERP 系统流程审批：总经理、人事经理、项目经理</li>
<li>Java 过滤器的底层实现 Filter</li>
</ul>

        <h1 id="3-结构图"   >
          <a href="#3-结构图" class="heading-link"><i class="fas fa-link"></i></a>3.结构图</h1>
      <p><img src="/source/images/1684046209393-3b485f3a-2769-482f-9ea2-74b557d1645e.png" alt="img"></p>
<ul>
<li><code>AbstractHandler</code>抽象责任人类：提供一个抽象类模板供下属责任人实现。有两个部分：其一是连接下一个责任人的对象以及其getter，setter方法；以及具体责任人要做的事情</li>
<li><code>Son</code>具体责任人类：实现抽象责任人类，并后续会连接起来。</li>
</ul>

        <h1 id="4-具体实现"   >
          <a href="#4-具体实现" class="heading-link"><i class="fas fa-link"></i></a>4.具体实现</h1>
      
        <h3 id="抽象责任人类"   >
          <a href="#抽象责任人类" class="heading-link"><i class="fas fa-link"></i></a>抽象责任人类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AbstractHandler nextAbstractHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextAbstractHandler</span><span class="params">(AbstractHandler nextAbstractHandler)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextAbstractHandler = nextAbstractHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> AbstractHandler <span class="title function_">getNextAbstractHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.nextAbstractHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">checkScore</span><span class="params">(<span class="type">int</span> score)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="具体责任人类"   >
          <a href="#具体责任人类" class="heading-link"><i class="fas fa-link"></i></a>具体责任人类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FirstPass</span> <span class="keyword">extends</span> <span class="title class_">AbstractHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">checkScore</span><span class="params">(<span class="type">int</span> score)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(score &gt; <span class="number">60</span> &amp;&amp; <span class="built_in">this</span>.getNextAbstractHandler() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getNextAbstractHandler().checkScore(score);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;很遗憾，没有通过第一关&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>记得加上<code>@Component</code>注解之后才能在spring初始化的时候被注入，<code>@Order(0)</code>表示位于该链条的顺序。</p>

        <h3 id="初始化类"   >
          <a href="#初始化类" class="heading-link"><i class="fas fa-link"></i></a>初始化类</h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChainService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AbstractHandler&gt; abstractHandlerList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AbstractHandler abstractHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; SCORE = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initAbstractHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; abstractHandlerList.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(i == <span class="number">0</span>) &#123;</span><br><span class="line">                abstractHandler = abstractHandlerList.get(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">AbstractHandler</span> <span class="variable">current</span> <span class="operator">=</span> abstractHandlerList.get(i - <span class="number">1</span>);</span><br><span class="line">                <span class="type">AbstractHandler</span> <span class="variable">next</span> <span class="operator">=</span> abstractHandlerList.get(i);</span><br><span class="line">                current.setNextAbstractHandler(next);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getScore</span><span class="params">(<span class="type">int</span> score)</span> &#123;</span><br><span class="line">        SCORE.add(abstractHandler.checkScore(score));</span><br><span class="line">        <span class="keyword">return</span> SCORE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>责任链初始化</p>
<p>首先在spring初始化前准备一个存储责任链模板元素的list集合用来存储责任链元素（列表会自动装配其类型的bean元素）</p>
<p>用<code>@PostConstruct</code>注解，将零散的责任链链条组装，成为一个完整的责任链。</p>
<p>还可以用枚举值的方式进行注入</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/post/21631/">锁</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="fa fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2023-06-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="fa fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2023-09-11</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="fa fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">2.4k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="fa fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">12分</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="全局锁"   >
          <a href="#全局锁" class="heading-link"><i class="fas fa-link"></i></a>全局锁</h1>
      <p>执行全局锁的命令：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush tables <span class="keyword">with</span> read lock</span><br></pre></td></tr></table></div></figure>

<p>执行命令以后，整个表都会处于只读阶段。只读阶段阻塞了如下操作：</p>
<ul>
<li>对于数据的增删改（insert， update， delete）</li>
<li>对于表结构的更改（drop，alter）</li>
</ul>
<p>主要应用场景为<strong>全局逻辑备份</strong>。</p>
<p>但是因为<code>inno DB</code>中有运用<code>read view</code>实现可重复读，修改后由于事务，数据库数据的一致性可以得到保证，所以造成无法改动的全局锁由于细粒度过大基本上被废弃。 </p>
<p>但是，对于 MyISAM 这种不支持事务的引擎，在备份数据库时就要使用全局锁的方法。</p>

        <h1 id="表级锁"   >
          <a href="#表级锁" class="heading-link"><i class="fas fa-link"></i></a>表级锁</h1>
      
        <h2 id="表锁"   >
          <a href="#表锁" class="heading-link"><i class="fas fa-link"></i></a>表锁</h2>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>表级别的共享锁，也就是读锁；</span><br><span class="line">lock tables t_student read;</span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>表级别的独占锁，也就是写锁；</span><br><span class="line">lock tables t_stuent write;</span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>释放当前会话的所有表锁</span><br><span class="line">unlock tables</span><br></pre></td></tr></table></div></figure>


        <h2 id="元数据锁（MDL）"   >
          <a href="#元数据锁（MDL）" class="heading-link"><i class="fas fa-link"></i></a>元数据锁（MDL）</h2>
      <p>元数据锁的目的是为了防止线程对表数据进行修改的时候，对于表格式进行变更，这个锁的对象是表的数据结构。</p>
<p>它分为读锁和写锁两种锁:</p>
<ul>
<li>当对于一张表做<strong>CRUD操作</strong>的时候，他新增的是<strong>MDL读锁</strong>；</li>
<li>当对于一张表做出<strong>表结构</strong>修改的时候，他新增的是<strong>MDL写锁</strong>。</li>
</ul>
<p>MDL锁的机制是读读共享，读写互斥，写写互斥。</p>
<p>申请MDL锁的事务会生成一个队列，写锁的优先级比读锁的要高。也就是说，当一张表加上了MDL读锁，之后有一个事务想要对表结构做出修改，加上MDL写锁，那么他之后的对于想要加入CRUD操作的读锁都是位于阻塞的状态。</p>

        <h2 id="意向锁"   >
          <a href="#意向锁" class="heading-link"><i class="fas fa-link"></i></a>意向锁</h2>
      <p><strong>意向锁的目的是为了快速判断表中是否有记录被加上了行级锁。</strong></p>
<p>原因是如果没有表的锁，需要一行一行判断有无加上行级锁，效率低下，加上意向锁可以达到剪枝的效果，排除完全没有被加上行级锁的表。</p>
<ul>
<li>当用InnoDB存储引擎的时候，当对于一条记录加上了共享锁，那么会对于其表加上意向共享锁。</li>
<li>当用InnoDB存储引擎的时候，当对于一条记录加上了独占锁，那么会对于其表加上意向独占锁。</li>
</ul>
<p>共享锁和独占锁是行级锁，意向独占锁和意向共享锁是表级锁。两者互不冲突。</p>

        <h2 id="AUTO-INC锁"   >
          <a href="#AUTO-INC锁" class="heading-link"><i class="fas fa-link"></i></a>AUTO-INC锁</h2>
      <p>在插入一条数据的时候，可以不输入主键就实现主键的自增，主要通过的就是<code>auto-inc</code>锁。</p>
<p>AUTO-INC 锁是特殊的表锁机制，锁<strong>不是再一个事务提交后才释放，而是再执行完插入语句后就会立即释放</strong>。</p>
<p>但是这种情况在大量插入的情况下，插入语句就变成了并行操作，容易导致执行效率的低下。</p>
<p>因此， 在 MySQL 5.1.22 版本开始，InnoDB 存储引擎提供了一种<strong>轻量级的锁</strong>来实现自增。</p>
<p>一样也是在插入数据的时候，会为被 AUTO_INCREMENT 修饰的字段加上轻量级锁，<strong>然后给该字段赋值一个自增的值，就把这个轻量级锁释放了，而不需要等待整个插入语句执行完后才释放锁</strong>。</p>
<p>这个时候减少了锁存在的时间，由新增语句完成后才释放锁提前到主键赋值完成就释放锁，减少了锁存在的时间，提高了锁的性能。</p>

        <h1 id="行级锁"   >
          <a href="#行级锁" class="heading-link"><i class="fas fa-link"></i></a>行级锁</h1>
      <figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span>对读取的记录加共享锁</span><br><span class="line"><span class="keyword">select</span> ... lock <span class="keyword">in</span> share mode;</span><br><span class="line"></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>对读取的记录加独占锁</span><br><span class="line"><span class="keyword">select</span> ... <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></div></figure>

<p>共享锁（S）满足读读共享，读写互斥，也就是可以被多个线程所持有。</p>
<p>独占锁（X）满足读写互斥，写写互斥，只能被一个线程所持有。</p>

        <h2 id="Record-Lock"   >
          <a href="#Record-Lock" class="heading-link"><i class="fas fa-link"></i></a>Record Lock</h2>
      <p>记录锁加锁的对象是一条数据。当对于一个事务加上了记录锁的时候，其他事务就不能对其进行修改。但是记录锁也有共享锁和独占锁的区别：</p>
<ul>
<li>当一个事务对一条记录加上了S（共享锁）的时候，其他事务仍然可以对其加上S锁，但不能对其加上X锁；</li>
<li>当一个事务对一条记录加上了X（独占锁）的时候，其他事务不能对加上S锁，也不能加上X锁。</li>
</ul>
<p>当提交时，所有的锁都会被释放。</p>

        <h2 id="Gap-Lock"   >
          <a href="#Gap-Lock" class="heading-link"><i class="fas fa-link"></i></a>Gap Lock</h2>
      <p>Gap Lock被称为间隙锁，只存在于可重复度级别，主要用于解决可重复度中的幻读问题。</p>
<p>比如表中有一个（2，5）的间隙锁，那么id &#x3D; 4的这条记录就无法再次被插入了。</p>
<p><strong>间隙锁之间是兼容的，即两个事务可以同时持有包含共同间隙范围的间隙锁，并不存在互斥关系。</strong></p>

        <h2 id="Next-Key-Lock"   >
          <a href="#Next-Key-Lock" class="heading-link"><i class="fas fa-link"></i></a>Next-Key Lock</h2>
      <p>Next-Key Lock 称为临键锁，是 Record Lock + Gap Lock 的组合，锁定一个范围，并且锁定记录本身。</p>
<p><strong>next-key lock 是包含间隙锁+记录锁的，如果一个事务获取了 X 型的 next-key lock，那么另外一个事务在获取相同范围的 X 型的 next-key lock 时，是会被阻塞的</strong>。</p>

        <h1 id="行级锁不同情况下是如何加锁的"   >
          <a href="#行级锁不同情况下是如何加锁的" class="heading-link"><i class="fas fa-link"></i></a>行级锁不同情况下是如何加锁的</h1>
      
        <h2 id="唯一索引等值查询"   >
          <a href="#唯一索引等值查询" class="heading-link"><i class="fas fa-link"></i></a>唯一索引等值查询</h2>
      <ul>
<li>当查询的记录是「存在」的，在索引树上定位到这一条记录后，将该记录的索引中的 next-key lock 会<strong>退化成「记录锁」</strong>。</li>
</ul>
<p><img src="/source/images/1685843643371-435561f7-f6e5-4db3-8ac4-7e243aa54b82.png" alt="img"></p>
<ul>
<li>当查询的记录是「不存在」的，在索引树找到第一条大于该查询记录的记录后，将该记录的索引中的 next-key lock 会<strong>退化成「间隙锁」</strong>。</li>
</ul>

        <h2 id="唯一索引非等值查询"   >
          <a href="#唯一索引非等值查询" class="heading-link"><i class="fas fa-link"></i></a>唯一索引非等值查询</h2>
      <p>当唯一索引进行范围查询时，<strong>会对每一个扫描到的索引加 next-key 锁，然后如果遇到下面这些情况，会退化成记录锁或者间隙锁</strong>：</p>
<ul>
<li><p>情况一：针对「大于等于」的范围查询，因为存在等值查询的条件，那么如果等值查询的记录是存在于表中，那么该记录的索引中的 next-key 锁会<strong>退化成记录锁</strong>。</p>
</li>
<li><p>情况二：针对「小于或者小于等于」的范围查询，要看条件值的记录是否存在于表中：</p>
</li>
<li><ul>
<li>当条件值的记录不在表中，那么不管是「小于」还是「小于等于」条件的范围查询，<strong>扫描到终止范围查询的记录时，该记录的索引的 next-key 锁会退化成间隙锁</strong>，其他扫描到的记录，都是在这些记录的索引上加 next-key 锁。</li>
<li>当条件值的记录在表中，如果是「小于」条件的范围查询，<strong>扫描到终止范围查询的记录时，该记录的索引的 next-key 锁会退化成间隙锁</strong>，其他扫描到的记录，都是在这些记录的索引上加 next-key 锁；如果「小于等于」条件的范围查询，扫描到终止范围查询的记录时，该记录的索引 next-key 锁不会退化成间隙锁。其他扫描到的记录，都是在这些记录的索引上加 next-key 锁。</li>
</ul>
</li>
</ul>

        <h2 id="非唯一索引等值查询"   >
          <a href="#非唯一索引等值查询" class="heading-link"><i class="fas fa-link"></i></a>非唯一索引等值查询</h2>
      <ul>
<li>当查询的记录「存在」时，由于不是唯一索引，所以肯定存在索引值相同的记录，于是<strong>非唯一索引等值查询的过程是一个扫描的过程，直到扫描到第一个不符合条件的二级索引记录就停止扫描，然后在扫描的过程中，对扫描到的二级索引记录加的是 next-key 锁，而对于第一个不符合条件的二级索引记录，该二级索引的 next-key 锁会退化成间隙锁。同时，在符合查询条件的记录的主键索引上加记录锁</strong>。</li>
<li>当查询的记录「不存在」时，<strong>扫描到第一条不符合条件的二级索引记录，该二级索引的 next-key 锁会退化成间隙锁。因为不存在满足查询条件的记录，所以不会对主键索引加锁</strong>。</li>
</ul>

        <h2 id="非唯一索引非等值查询"   >
          <a href="#非唯一索引非等值查询" class="heading-link"><i class="fas fa-link"></i></a>非唯一索引非等值查询</h2>
      <p>非唯一索引和主键索引的范围查询的加锁也有所不同，不同之处在于<strong>非唯一索引范围查询，索引的 next-key lock 不会有退化为间隙锁和记录锁的情况</strong>，也就是非唯一索引进行范围查询时，对二级索引记录加锁都是加 next-key 锁。</p>

        <h2 id="非索引查询"   >
          <a href="#非索引查询" class="heading-link"><i class="fas fa-link"></i></a>非索引查询</h2>
      <p><strong>如果锁定读查询语句，没有使用索引列作为查询条件，或者查询语句没有走索引查询，导致扫描是全表扫描。那么，每一条记录的索引上都会加 next-key 锁，这样就相当于锁住的全表，这时如果其他事务对该表进行增、删、改操作的时候，都会被阻塞</strong>。</p>
<p>将<code>sql_safe_updates</code> 设置为1，开启安全更新模式。</p>
<p>update 语句必须满足如下条件之一才能执行成功：</p>
<ul>
<li>使用 where，并且 where 条件中必须有索引列；</li>
<li>使用 limit；</li>
<li>同时使用 where 和 limit，此时 where 条件中可以没有索引列；</li>
</ul>
</div></div></article></section><nav class="paginator"><div class="paginator-inner"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/myphoto.png" alt="avatar"></div><p class="sidebar-ov-author__text">道阻且长,行则将至</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://plus.google.com/" target="_blank" rel="noopener" data-popover="Google" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-google"></i></span></a><a class="sidebar-ov-social-item" href="https://twitter.com/" target="_blank" rel="noopener" data-popover="Twitter" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-twitter"></i></span></a><a class="sidebar-ov-social-item" href="https://youtube.com/" target="_blank" rel="noopener" data-popover="Youtube" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-youtube"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">29</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">9</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">9</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-cn" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023</span><span class="footer__icon"><i class="fa fa-heart"></i></span><span>Arong</span></div><div>加油！一起学习一起成长</div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script></body></html>